<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Change CESM/CLM Surface to Pure Bare Ground</title>
    <meta name="description" content="  ReferencesIn our hierarchy experiments, we hope to make the NO_TOPO series experiments as simple as possible. Thus, it would be great if there is no vegeta...">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_8v3czwksspqlg14i.css">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://202.116.70.212:80/2018/06/05/clm-landuse/">
    <link rel="alternate" type="application/rss+xml" title="LZN's Blog" href="http://202.116.70.212:80/feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?f8f21649f9d39b36012bc6dac8898310";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>




</head>


  <body>

    <canvas id="c"  style="postion:fixed;left:0px;top:0px;width:100%;height:800px;"></canvas>
    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">LZN's Blog</a>
        <small>Model Player</small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-clock-o"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-server"></i>Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>Tags
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/Side Projects/">
                        
                            <i class="fa fa-bar-chart"></i>Side Projects
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/sandbox/">
                        
                            <i class="fa fa-flask"></i>Sandbox
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/favorites/">
                        
                            <i class="fa fa-heart"></i>Favorites
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-id-card-o"></i>About
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/comments/">
                        
                            <i class="fa fa-comments"></i>Comments
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>Change CESM/CLM Surface to Pure Bare Ground</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2018-06-05
            </div>

            <div class="label-card">
                <i class="fa fa-user"></i>LZN
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#cesm" title="Category: cesm" rel="category">cesm</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#cesm" title="Tag: cesm" rel="tag">cesm</a-->
        <a href="/tag/#cesm" title="Tag: cesm" rel="tag">cesm</a>&nbsp;
    
        <!--a href="/tag/#clm" title="Tag: clm" rel="tag">clm</a-->
        <a href="/tag/#clm" title="Tag: clm" rel="tag">clm</a>&nbsp;
    
        <!--a href="/tag/#pft" title="Tag: pft" rel="tag">pft</a-->
        <a href="/tag/#pft" title="Tag: pft" rel="tag">pft</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#references" id="markdown-toc-references">References</a></li>
</ul>

<p>In our hierarchy experiments, we hope to make the <a href="https://novarizark.github.io/2018/06/06/cesm-fully-coupled-aquap/">NO_TOPO series experiments</a> as simple as possible. Thus, it would be great if there is no vegetation on the ground. 
In the CLM, we expect there is an external forcing data to control the surface type of ground/vegetation. Then I found this in <code class="highlighter-rouge">lnd_in</code> file</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fsurdat</span> <span class="o">=</span> <span class="s">'/users/yangsong3/CESM/input/lnd/clm2/surfdata/surfdata_1.9x2.5_simyr2000_c091005.nc'</span>
</code></pre></div></div>

<p>If you <code class="highlighter-rouge">ncdump</code> that file, you will see this variable:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">double</span> <span class="n">PCT_PFT</span><span class="p">(</span><span class="n">lsmpft</span><span class="p">,</span> <span class="n">lsmlat</span><span class="p">,</span> <span class="n">lsmlon</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">PCT_PFT</span><span class="p">:</span><span class="n">long_name</span> <span class="o">=</span> <span class="s">"percent plant functional type of gridcell"</span> <span class="p">;</span>
		<span class="n">PCT_PFT</span><span class="p">:</span><span class="n">units</span> <span class="o">=</span> <span class="s">"unitless"</span> <span class="p">;</span>
</code></pre></div></div>

<p>The first dimension show the corresponding PFT (Plant Functional Types), which define the types and fraction of different landcovers a certain grid (Mosaic method). There is the code table:</p>

<p><img src="https://ws1.sinaimg.cn/large/73ebdc71ly1fs0m9y9g3oj20kb0ie0ve.jpg" alt="" /></p>

<p>Thus, the only thing we need to do is to create a new file with change only in PCT_PFT(0,:,:)=100.0.</p>

<p><strong>Updated 2018-06-05</strong></p>

<p>When we tried to run the model, we got several errors.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>surfrd_wtxy_veg_all ERROR: sum<span class="o">(</span>pct<span class="o">)</span> over numpft+1 is not <span class="o">=</span> 100.
490    100.106661159475       0.106661159474527             4473
</code></pre></div></div>

<p>According to the error, it seems that the sum of pft is not 100. After checking the data, we found several variables:</p>

<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pct_list</span><span class="o">=</span><span class="p">(/</span><span class="s2">"PCT_LAKE"</span><span class="p">,</span><span class="w"> </span><span class="s2">"PCT_WETLAND"</span><span class="p">,</span><span class="w"> </span><span class="s2">"PCT_GLACIER"</span><span class="p">,</span><span class="w"> </span><span class="s2">"PCT_URBAN"</span><span class="p">/)</span><span class="w">
</span></code></pre></div></div>
<p>So I remain all the pct about water, urban, and glacier, and make the bare ground equal to <code class="highlighter-rouge">100-sum(pct_list)</code>.</p>

<p>Note that after changing all the landuse pct, the default CLM initial condition cannot satisfy the model, so we need to “cold” start the model. Use <code class="highlighter-rouge">env_run.xml</code> to set it.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;entry</span> <span class="na">id=</span><span class="s">"CLM_FORCE_COLDSTART"</span>   <span class="na">value=</span><span class="s">"on"</span>  <span class="nt">/&gt;</span>
</code></pre></div></div>

<p><strong>Updated 2018-06-06</strong></p>

<p>Some issues happened after 10+ years integration. In no_topo experiment, the model exit with error in 0013-03, with Error message:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(shr_sys_abort) ERROR: remap transport: bad departure points 
  
(shr_sys_abort) WARNING: calling shr_mpi_abort() and stopping
 Warning: Departure points out of bounds in remap
 my_task, i, j =          31          20          13     
application called MPI_Abort(MPI_COMM_WORLD, 1001) - process 0
 dpx, dpy =  -28367.4880120091        54137.9986747345     
 HTN(i,j), HTN(i+1,j) =   30148.1831506031        30030.4921250813     
 HTE(i,j), HTE(i,j+1) =   46470.5086842257        46750.9484318852     
 istep1, my_task, iblk =     1310809          31           2      
 Global block:         241    
 Global i and j:          19         372    
</code></pre></div></div>

<p>After searching, it seems that the CICE model encountered a CFL violation problem:</p>

<blockquote>
  <p>This is essentially a CFL violation in the CICE model. You would need to reduce the timestep. In the CESM, the CICE timestep is tied to the coupling interval with the atmosphere. Have a look at ATM_NCPL and ICE_NCPL. Try doubling ATM_NCPL and this should help. For high resolution (0.1-degree) you can use xndt_dyn or ndtd depending on the version of the code. This allows you to take multiple dynamic timesteps per thermodynamic timestep.</p>
</blockquote>

<p>I found ATM_NCPL in env_run.xml:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--"base period associated with NCPL coupling frequency, valid values: hour,day,year,decade (char) " --&gt;</span>
<span class="nt">&lt;entry</span> <span class="na">id=</span><span class="s">"NCPL_BASE_PERIOD"</span>   <span class="na">value=</span><span class="s">"day"</span>  <span class="nt">/&gt;</span>    

<span class="c">&lt;!--"number of atm coupling intervals per NCPL_BASE_PERIOD (integer) (char) " --&gt;</span>
<span class="nt">&lt;entry</span> <span class="na">id=</span><span class="s">"ATM_NCPL"</span>   <span class="na">value=</span><span class="s">"48"</span>  <span class="nt">/&gt;</span>
</code></pre></div></div>
<p>Since the atm run in <code class="highlighter-rouge">dtime=1800s</code>, double the <code class="highlighter-rouge">ATM_NCPL</code> is meaningless.</p>

<p><a href="http://www.cesm.ucar.edu/models/cesm1.0/cice/doc/node35.html">Another strategy</a> is to double the CICE dynamic timesteps per thermodynamic timestep.</p>

<blockquote>
  <p>The dynamics timestep should be reduced to integrate past this problem. Set
<code class="highlighter-rouge">xndt_dyn = 2</code>
in the namelist and restart the model. When the job completes set the value back to 1.</p>
</blockquote>

<p>That is quite interesting, set it back when pass the unstable point? How could there be this operation?!</p>

<p>Still confused, then I turned to <code class="highlighter-rouge">NO_TOPO_SCON</code> and found another similar error happened in the ocean model:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POP Exiting...
POP_SolversChronGear: solver not converged
POP_SolverRun: error in ChronGear
POP_BarotropicDriver: error in solver 
Step: error in barotropic
</code></pre></div></div>

<p>And I searched and found the POP FAQ:</p>

<blockquote>
  <p>If your case has been running successfully for a period of time, but then the ocean model suddenly fails to converge, you might have encountered a time-stepping instability. If so, you will need to decrease the ocean timestep and restart your case. We recommend you back up at least one month prior to the time of nonconvergence, <strong>decrease the ocean-model timestep by about 15-20%</strong>, and then restart your case.</p>
</blockquote>

<p>And the method to change the timestep:</p>
<blockquote>
  <p>To change the size of the POP2 timestep, you simply change the value of dt_count in your $CASE/user_nl_pop2 file.</p>
</blockquote>

<blockquote>
  <p>To decrease the POP2 timestep, you must increase the POP2 time_manager_nml namelist variable dt_count.</p>
</blockquote>

<blockquote>
  <p>For example, if the ocean grid in your case is gx1v6, then the default value for dt_count is 23. In order decrease the timestep by roughly 15%, you would increase dt_count to 26. To do this, put the following line in your <code class="highlighter-rouge">$CASE/user_nl_pop2</code> file:</p>
</blockquote>

<blockquote>
  <p><code class="highlighter-rouge">dt_count = 26</code>
You do not need to rebuild the executable in order to change dt_count.</p>
</blockquote>

<p>Considering doubling the CICE dynamic timesteps will significantly increase the integration time. I tried the following method:</p>

<ul>
  <li>In <code class="highlighter-rouge">user_nl_pop2</code>:</li>
</ul>

<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dt_count</span><span class="o">=</span><span class="mi">26</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>Turn off cold start of the CLM and use 5-day clm2.r file to remap a new file with bare ground.</li>
</ul>

<p>According to the <a href="http://www.cesm.ucar.edu/models/paleo/faq/#lnd">paleo FAQ</a>:</p>

<blockquote>
  <p>However, if you have changed your land cover in your new simulation (for example, if you have changed your land ice distribution), you will first need to create a new clm2.r file that conforms to the new land cover assignments in your modified surface datafile.  Creating a new clm2.r file is a two step process.  Step 1:  Run a short (e.g., 5 day) startup simulation with arbitrary initial conditions and your new surface dataset. The 5 day simulation will produce a restart file that is consistent with the ice distribution in your new surface dataset, which is different from the original experiment that you wish to branch from.  Use the tool, interpinic, to re-map the restart data from the original simulation to the new restart file created by the 5-day run.</p>
</blockquote>

<p>I used to cold start the model, it seems this can be a big problem:</p>
<blockquote>
  <p>CLM4 does not require an initial condition file and can be initialized with arbitrary initialization (finidat=” “). However, arbitrary initialization starts the model from essentially bare ground, with vegetation, soil carbon, soil nitrogen, and soil moisture set to zero. The land model will spin up all variables at once, but will therefore require many hundreds of years to come into equilibrium.</p>
</blockquote>

<p>Following the instruction, we first startup a <code class="highlighter-rouge">NO_TOPO</code> experiment with 5 day integration and our own bare ground surface data. Then, use <code class="highlighter-rouge">interpinic</code> to remap a <code class="highlighter-rouge">REAL_WORLD</code> restart file to our 5-day restart file:
Path: <code class="highlighter-rouge">/users/yangsong3/CESM/cesm1_2_2/models/lnd/clm/tools/clm4_0/interpinic</code></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./interpinic <span class="nt">-i</span>  /users/yangsong3/L_Zealot/B/B20f19-realworld/exe/B20f19-realworld.clm2.r.0021-01-01-00000.nc <span class="nt">-o</span> /users/yangsong3/L_Zealot/B/B20f19-topo/clm.r/B20f19-topo.clm2.r.interpinic.nc 
</code></pre></div></div>

<p>After that, I thought for a while and tried to comment out the pop timestep change, turn off CLM cold start, and use frequent restart file output (10 year).</p>

<h3 id="references">References</h3>

<ul>
  <li><a href="https://bb.cgd.ucar.edu/error-remap-transport-bad-departure-points">https://bb.cgd.ucar.edu/error-remap-transport-bad-departure-points</a></li>
  <li><a href="http://www.cesm.ucar.edu/models/cesm1.0/cice/doc/node35.html">http://www.cesm.ucar.edu/models/cesm1.0/cice/doc/node35.html</a></li>
  <li><a href="http://www.cesm.ucar.edu/models/paleo/faq/#lnd">http://www.cesm.ucar.edu/models/paleo/faq/#lnd</a></li>
</ul>

<p><strong>Updated 2018-06-11</strong></p>

        </article>
        <hr>

        
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <h2 id="similar_posts">Similar Posts</h2>
                        <ul>
                        
                        <li class="relatedPost">
                            <a href="/2018/06/06/cesm-fully-coupled-aquap/">CESM Fully Coupled Aqua-Planet Experiments
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2018/05/24/cesm-aquap/">CESM测试Aqua Planet试验
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
        
            </ul>
        

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2018/06/02/ill-again/">我TM又病了</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2018/06/05/ubuntu-parted/">Ubuntu下用parted分区4TB硬盘</a></p>
        
    </div>
</div>


<!--        <h2 id="comments">Comments</h2>
    




<div id="container"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
var gitment = new Gitment({
  id: 'location.href', // 可选。默认为 location.href
  owner: 'Novarizark',
  repo: 'Novarizark.github.io',
  oauth: {
    client_id: '08594414abfaba1aa8bd',
    client_secret: '56bd0f234257f69ca94cafa5086af0ff2e43ac70',
  },
})
gitment.render('container')
</script>
<noscript>Please enable JavaScript to view the <a href="https://imsun.github.io/gitment/" rel="nofollow">comments powered by Gitment.</a></noscript>

 -->


    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <li><a href="#similar_posts">Similar Posts</a></li>
                    
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
            
        </p>
        <p class="contact">
            Contact me at: 
            <a href="https://github.com/Novarizark" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>  
            <a href="mailto:lzhenn@mail2.sysu.edu.cn" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>        
        </p>
        <p>
            本站总访问量<span id="busuanzi_value_site_pv"></span>次，本站访客数<span id="busuanzi_value_site_uv"></span>人次，本文总阅读量<span id="busuanzi_value_page_pv"></span>次
        </p>
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a>.
            </span>
            <span>
                Theme designed by <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
        </p>
    </div>
</footer>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
    <script src="/js/cmatrix.js" charset="utf-8"></script>
    <!-- <script src=" /js/scroll.min.js " charset="utf-8"></script> -->
  </body>

</html>
